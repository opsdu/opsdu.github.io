<!doctype html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="generator" content="TiddlyWiki" />
<meta name="tiddlywiki-version" content="5.3.5" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="mobile-web-app-capable" content="yes"/>
<meta name="format-detection" content="telephone=no">
<link id="faviconLink" rel="shortcut icon" href="favicon.ico">
<link rel="stylesheet" href="static.css">
<title>zabbix-agent全自动安装和配置: 记录我的技术日常 — 一个在IT摸爬打滚的苦逼工作者</title>
</head>
<body class="tc-body">

<section class="tc-story-river tc-static-story-river">
<p><div class="tc-tiddler-frame tc-tiddler-view-frame tc-tiddler-exists  tc-tagged-zabbix tc-tagged-%E8%84%9A%E6%9C%AC tc-tagged-%E8%87%AA%E5%8A%A8%E5%AE%89%E8%A3%85 tc-tagged-%E7%9B%91%E6%8E%A7" data-tags="zabbix 脚本 自动安装 监控" data-tiddler-title="zabbix-agent全自动安装和配置" role="article"><div class="tc-tiddler-title"><div class="tc-titlebar"><span class="tc-tiddler-controls"><button aria-expanded="false" aria-label="更多" class="tc-btn-invisible tc-btn-%24%3A%2Fcore%2Fui%2FButtons%2Fmore-tiddler-actions" title="更多操作"></button><span class=" tc-reveal" hidden="true"></span><button aria-label="编辑" class="tc-btn-invisible tc-btn-%24%3A%2Fcore%2Fui%2FButtons%2Fedit" title="编辑此条目"></button><button aria-label="关闭" class="tc-btn-invisible tc-btn-%24%3A%2Fcore%2Fui%2FButtons%2Fclose" title="关闭此条目"></button></span><span><h2 class="tc-title">zabbix-agent全自动安装和配置</h2></span></div><div class="tc-tiddler-info tc-popup-handle tc-reveal" hidden="true"></div></div><div class="tc-reveal"></div><div class=" tc-reveal"><div class="tc-subtitle"><a class="tc-tiddlylink tc-tiddlylink-missing" href="fxz.html">fxz</a> 2024年10月17日 10:13</div></div><div class=" tc-reveal"><div class="tc-tags-wrapper"><span class="tc-tag-list-item" data-tag-title="zabbix"><span aria-expanded="false" class="tc-tag-label tc-btn-invisible" draggable="true" style="fill:#333333;color:#333333;"><span class="tc-tag-missing">zabbix</span></span><span class="tc-drop-down tc-reveal" hidden="true"></span></span><span class="tc-tag-list-item" data-tag-title="监控"><span aria-expanded="false" class="tc-tag-label tc-btn-invisible" draggable="true" style="fill:#333333;color:#333333;"><span class="tc-tag-missing">监控</span></span><span class="tc-drop-down tc-reveal" hidden="true"></span></span><span class="tc-tag-list-item" data-tag-title="脚本"><span aria-expanded="false" class="tc-tag-label tc-btn-invisible" draggable="true" style="fill:#333333;color:#333333;"><span class="tc-tag-missing">脚本</span></span><span class="tc-drop-down tc-reveal" hidden="true"></span></span><span class="tc-tag-list-item" data-tag-title="自动安装"><span aria-expanded="false" class="tc-tag-label tc-btn-invisible" draggable="true" style="fill:#333333;color:#333333;"><span class="tc-tag-missing">自动安装</span></span><span class="tc-drop-down tc-reveal" hidden="true"></span></span></div></div><div class="tc-tiddler-body tc-reveal"><pre class="hljs"><code class="bash hljs"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># 检查操作系统类型</span>
<span class="hljs-keyword">if</span> [ -f /etc/os-release ]; <span class="hljs-keyword">then</span>
    . /etc/os-release
    OS=<span class="hljs-variable">$ID</span>
<span class="hljs-keyword">else</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;无法识别操作系统类型。&quot;</span>
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># 安装依赖</span>
<span class="hljs-keyword">if</span> [[ <span class="hljs-string">&quot;<span class="hljs-variable">$OS</span>&quot;</span> == <span class="hljs-string">&quot;ubuntu&quot;</span> || <span class="hljs-string">&quot;<span class="hljs-variable">$OS</span>&quot;</span> == <span class="hljs-string">&quot;debian&quot;</span> ]]; <span class="hljs-keyword">then</span>
    <span class="hljs-comment"># Debian/Ubuntu 系列</span>
    sudo apt update
    <span class="hljs-keyword">if</span> ! dpkg -l | grep -q build-essential; <span class="hljs-keyword">then</span>
        sudo apt install -y build-essential wget
    <span class="hljs-keyword">fi</span>
<span class="hljs-keyword">elif</span> [[ <span class="hljs-string">&quot;<span class="hljs-variable">$OS</span>&quot;</span> == <span class="hljs-string">&quot;centos&quot;</span> || <span class="hljs-string">&quot;<span class="hljs-variable">$OS</span>&quot;</span> == <span class="hljs-string">&quot;openEuler&quot;</span> ]]; <span class="hljs-keyword">then</span>
    <span class="hljs-comment"># CentOS/openEuler 系列</span>
    sudo yum install -y epel-release
    <span class="hljs-keyword">if</span> ! rpm -qa | grep -q <span class="hljs-string">&quot;pcre&quot;</span>; <span class="hljs-keyword">then</span>
        sudo yum install -y pcre pcre-devel <span class="hljs-comment">#gcc make zlib-devel openssl-devel libxml2-devel wget</span>
    <span class="hljs-keyword">fi</span>
<span class="hljs-keyword">else</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;不支持的操作系统类型：<span class="hljs-variable">$OS</span>&quot;</span>
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># 定义要检查的文件和目录</span>
<span class="hljs-built_in">cd</span> /usr/local/src
<span class="hljs-built_in">dir</span>=<span class="hljs-string">&quot;zabbix-7.0.2&quot;</span>

<span class="hljs-comment"># 检查目录是否存在,不存在则下载</span>
<span class="hljs-keyword">if</span> [ -d <span class="hljs-string">&quot;<span class="hljs-variable">$dir</span>&quot;</span> ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Directory &#x27;<span class="hljs-variable">$dir</span>&#x27; exists.&quot;</span>
<span class="hljs-keyword">else</span>
    wget http://ibenyi.tk/zabbix-7.0.2.tar.gz
    tar zxvf zabbix-7.0.2.tar.gz
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># 安装 Zabbix</span>
<span class="hljs-built_in">cd</span> zabbix-7.0.2
./configure --enable-agent
<span class="hljs-keyword">if</span> [ $? -ne 0 ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Configure 失败，脚本终止。&quot;</span>
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>

make
<span class="hljs-keyword">if</span> [ $? -ne 0 ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Make 失败，脚本终止。&quot;</span>
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>

sudo make install
<span class="hljs-keyword">if</span> [ $? -ne 0 ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Make install 失败，脚本终止。&quot;</span>
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># 创建 Zabbix 用户和组</span>
<span class="hljs-keyword">if</span> [[ <span class="hljs-string">&quot;<span class="hljs-variable">$OS</span>&quot;</span> == <span class="hljs-string">&quot;ubuntu&quot;</span> || <span class="hljs-string">&quot;<span class="hljs-variable">$OS</span>&quot;</span> == <span class="hljs-string">&quot;debian&quot;</span> ]]; <span class="hljs-keyword">then</span>
    addgroup --system --quiet zabbix
    adduser --quiet --system --disabled-login --ingroup zabbix --home /var/lib/zabbix --no-create-home zabbix
<span class="hljs-keyword">else</span>
    groupadd --system zabbix
    useradd --system -g zabbix -d /usr/lib/zabbix -s /sbin/nologin -c <span class="hljs-string">&quot;Zabbix Monitoring System&quot;</span> zabbix
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># 创建日志和运行目录</span>
sudo <span class="hljs-built_in">mkdir</span> -p /var/log/zabbix
sudo <span class="hljs-built_in">mkdir</span> -p /var/run/zabbix
sudo <span class="hljs-built_in">chown</span> zabbix:zabbix /usr/local/sbin/zabbix_agentd
sudo <span class="hljs-built_in">chown</span> -R zabbix:zabbix /usr/local/etc/zabbix_agentd.conf /usr/local/etc/zabbix_agentd.conf.d /var/log/zabbix /var/run/zabbix
ip=$(hostname -I |awk {<span class="hljs-string">&#x27;print $1&#x27;</span>})

<span class="hljs-comment"># 修改配置文件</span>
sudo sed -i <span class="hljs-string">&#x27;12i PidFile=/tmp/zabbix_agentd.pid&#x27;</span> /usr/local/etc/zabbix_agentd.conf
sudo sed -i <span class="hljs-string">&#x27;s/^Server=127.0.0.1/Server=192.168.1.222/&#x27;</span> /usr/local/etc/zabbix_agentd.conf
sudo sed -i <span class="hljs-string">&#x27;s#^LogFile=/tmp/zabbix_agentd.log#LogFile=/var/log/zabbix/zabbix_agentd.log#&#x27;</span> /usr/local/etc/zabbix_agentd.conf
sudo sed -i <span class="hljs-string">&#x27;s/^# DebugLevel=3/DebugLevel=3/&#x27;</span> /usr/local/etc/zabbix_agentd.conf
sudo sed -i <span class="hljs-string">&#x27;s/^# AllowRoot=0/AllowRoot=1/&#x27;</span> /usr/local/etc/zabbix_agentd.conf
sudo sed -i <span class="hljs-string">&#x27;s/^# HostnameItem=system.hostname/HostnameItem=system.hostname/&#x27;</span> /usr/local/etc/zabbix_agentd.conf
sudo sed -i <span class="hljs-string">&quot;s/^Hostname=Zabbix server/Hostname=<span class="hljs-variable">$ip</span>/&quot;</span> /usr/local/etc/zabbix_agentd.conf
sudo sed -i <span class="hljs-string">&#x27;s/^# User=zabbix/User=zabbix/&#x27;</span> /usr/local/etc/zabbix_agentd.conf
sudo sed -i <span class="hljs-string">&#x27;s/^# Include=\/usr\/local\/etc\/zabbix_agentd.conf.d\/\*.conf/Include=\/usr\/local\/etc\/zabbix_agentd.conf.d\/\*.conf/&#x27;</span> /usr/local/etc/zabbix_agentd.conf
sudo sed -i <span class="hljs-string">&#x27;s/^# UnsafeUserParameters=0/UnsafeUserParameters=1/&#x27;</span> /usr/local/etc/zabbix_agentd.conf
sudo sed -i <span class="hljs-string">&#x27;s/^# UserParameterDir=/UserParameterDir=\/usr\/local\/etc\/zabbix\/zabbix_agentd.conf.d/&#x27;</span> /usr/local/etc/zabbix_agentd.conf
sudo sed -i <span class="hljs-string">&#x27;s/^ServerActive=127.0.0.1/ServerActive=192.168.1.222/&#x27;</span> /usr/local/etc/zabbix_agentd.conf
sudo <span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;AllowKey=system.run[*]&#x27;</span> &gt;&gt; /usr/local/etc/zabbix_agentd.conf

<span class="hljs-comment"># 设置禁用selinux</span>
sestatus
<span class="hljs-keyword">if</span> [[ <span class="hljs-string">&quot;<span class="hljs-subst">$(getenforce)</span>&quot;</span> != <span class="hljs-string">&quot;Disabled&quot;</span> &amp;&amp; <span class="hljs-string">&quot;<span class="hljs-subst">$(getenforce)</span>&quot;</span> != <span class="hljs-string">&quot;disabled&quot;</span> ]]; <span class="hljs-keyword">then</span>
    sudo sed -i <span class="hljs-string">&#x27;s/^SELINUX=.*/SELINUX=disabled/&#x27;</span> /etc/selinux/config
    sudo setenforce 0
<span class="hljs-keyword">fi</span>

<span class="hljs-keyword">if</span> [[ <span class="hljs-string">&quot;<span class="hljs-variable">$OS</span>&quot;</span> == <span class="hljs-string">&quot;ubuntu&quot;</span> || <span class="hljs-string">&quot;<span class="hljs-variable">$OS</span>&quot;</span> == <span class="hljs-string">&quot;debian&quot;</span> ]]; <span class="hljs-keyword">then</span>
    <span class="hljs-comment"># Debian/Ubuntu 系列开放防火墙</span>
    ufw_status=$(sudo ufw status | grep -o <span class="hljs-string">&quot;Status: active&quot;</span>)
    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;UFW status: <span class="hljs-variable">$ufw_status</span>&quot;</span>

    <span class="hljs-comment"># 如果 ufw 在运行，则开放 10050/tcp 端口</span>
    <span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$ufw_status</span>&quot;</span> = <span class="hljs-string">&quot;Status: active&quot;</span> ]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Opening port 10050/tcp...&quot;</span>
        sudo ufw allow 10050/tcp
        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Port 10050/tcp has been opened.&quot;</span>

        <span class="hljs-comment"># 验证端口是否开放</span>
        sudo ufw status | grep 10050/tcp
        <span class="hljs-keyword">if</span> [ $? -eq 0 ]; <span class="hljs-keyword">then</span>
            <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Port 10050/tcp is successfully opened.&quot;</span>
        <span class="hljs-keyword">else</span>
            <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Failed to open port 10050/tcp.&quot;</span>
        <span class="hljs-keyword">fi</span>
    <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;UFW is not running.&quot;</span>
    <span class="hljs-keyword">fi</span>
<span class="hljs-keyword">elif</span> [[ <span class="hljs-string">&quot;<span class="hljs-variable">$OS</span>&quot;</span> == <span class="hljs-string">&quot;centos&quot;</span> || <span class="hljs-string">&quot;<span class="hljs-variable">$OS</span>&quot;</span> == <span class="hljs-string">&quot;openEuler&quot;</span> ]]; <span class="hljs-keyword">then</span>
    <span class="hljs-comment"># CentOS/Redhat/Openeuler开放防火墙方式</span>

    <span class="hljs-comment"># 检查 firewalld 状态</span>
    firewalld_status=$(sudo systemctl is-active firewalld)
    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Firewalld status: <span class="hljs-variable">$firewalld_status</span>&quot;</span>

    <span class="hljs-comment"># 如果 firewalld 在运行，则开放 10050/tcp 端口</span>
    <span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$firewalld_status</span>&quot;</span> = <span class="hljs-string">&quot;active&quot;</span> ]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Opening port 10050/tcp...&quot;</span>
        sudo firewall-cmd --zone=public --add-port=10050/tcp --permanent
        sudo firewall-cmd --reload
        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Port 10050/tcp has been opened.&quot;</span>

        <span class="hljs-comment"># 验证端口是否开放</span>
        <span class="hljs-keyword">if</span> sudo firewall-cmd --zone=public --query-port=10050/tcp; <span class="hljs-keyword">then</span>
            <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Port 10050/tcp is successfully opened.&quot;</span>
        <span class="hljs-keyword">else</span>
            <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Failed to open port 10050/tcp.&quot;</span>
        <span class="hljs-keyword">fi</span>
    <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Firewalld is not running.&quot;</span>
    <span class="hljs-keyword">fi</span>
<span class="hljs-keyword">else</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;未安装！&quot;</span>
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># 创建 systemd 服务文件</span>
sudo <span class="hljs-built_in">tee</span> /etc/systemd/system/zabbix-agent.service &gt; /dev/null &lt;&lt;<span class="hljs-string">EOL
[Unit]
Description=Zabbix Agent
After=network.target

[Service]
Type=simple
User=zabbix
ExecStart=/usr/local/sbin/zabbix_agentd -c /usr/local/etc/zabbix_agentd.conf
ExecStop=/bin/kill -SIGTERM \$MAINPID
PIDFile=/tmp/zabbix_agentd.pid
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOL</span>

<span class="hljs-comment"># 启动和开机启用 Zabbix Agent 服务</span>
sudo systemctl start zabbix-agent.service
sudo systemctl <span class="hljs-built_in">enable</span> zabbix-agent.service
sudo systemctl is-active zabbix-agent.service
netstat -anpoo | grep 10050</code></pre></div>
</div></p>
</section>
</body>
</html>

